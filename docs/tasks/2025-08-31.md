
# Daily Task — 2025-08-30

## 0) 任務一句話

打通最小權威伺服器的流程，走讀並固定資料路徑規律；在抽象層定義七個 DSA 的最小介面與不變量；實作並測試其中一個模組，準備 v1（快取三件套）的地基。

**非目標**：不做生產級硬化；不開 53 埠；不實作 DNSSEC/EDNS；不追求效能優化。

---

## 1) 設計護欄（硬規則）

* 單一時間來源：核心不直接讀系統時鐘；`now` 一律由外部注入。
* I/O 與核心分離：`net_io/` 處理封包解析/編碼；核心只做行為與資料結構。
* 固定資料路徑：`bytes → parse → policy → DSA(core) → policy → encode → bytes`。
* 錯誤分層：語法錯誤止於解析層；資源/逾時止於計時層；門面層僅保證參數合法性。

---

## 2) 今日節奏（建議順序）

1. 環境就緒
2. 跑通最小伺服器
3. 走讀核心鏈並在 README 記下一行資料路徑
4. 七個 DSA：寫最小介面與不變量註記（抽象）
5. 實作一個 DSA（`cache_tbl` 或 `ttl_heap`）
6. 測試與紀錄
7. 設定占位（timeout / retry）
8. 對外檔案與 Roadmap 勾點
   9.（選做）封包觀測

---

## 3) 任務與操作

### A. 環境就緒（.venv + 依賴）

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install --upgrade pip
pip install dnslib pytest
pytest -q
```

**產出**：`shell.log`（含 `python -V`、`pip freeze | sort`、`pytest -q` 結果）

---

### B. 跑通最小伺服器（本機 127.0.0.1:8053）

```bash
python examples/server_authoritative_min.py
# 另開一個終端或分割窗
dig @127.0.0.1 -p 8053 example.lab A
```

**產出**：`dig_output.txt`（包含 ANSWER SECTION）

---

### C. 走讀核心鏈（server\_api → resolver → ds/\*）

* 快速看：`server_api.py → dns_core/resolver.py → dns_core/ds/*`
* 在 README 末端新增一行**資料路徑備忘**：
  `bytes → parse → policy → DSA(core) → policy → encode → bytes`
  **產出**：README 的 diff（新增該一行）

---

### D. 七個 DSA：最小介面與不變量（檔頭 docstring）

在下列檔案檔頭加入 **介面草案 + 一句不變量**：

* `cache_tbl.py`

  * API：`get(k)`, `put(k, rrset, ttl)`, `delete(k)`
  * INV：同一鍵同一時間最多一筆有效答；過期即 miss。
* `ttl_heap.py`

  * API：`push(deadline, k)`, `pop_expired(now)`, `peek_deadline()`
  * INV：堆頂是最早 deadline；彈出次序非遞減。
* `lru_dlist.py`

  * API：`touch(k)`, `evict_tail()`, `remove(k)`
  * INV：命中移表頭；淘汰從表尾。
* `inflight_map.py`

  * API：`acquire(k)->owner|wait`, `resolve(k,v)`, `fail(k,err)`
  * INV：同鍵同時僅一個外送任務存活。
* `timer_heap.py`

  * API：`arm(tid, deadline)`, `fire_due(now)`, `cancel(tid)`
  * INV：事件按 deadline 非遞減觸發。
* `ns_ring.py`

  * API：`next()`, `penalize(ns)`, `reset()`
  * INV：指針公平輪替；失敗累積懲罰或退避。
* `visited_set.py`

  * API：`enter(k)`, `seen(k)`, `leave(k)`
  * INV：鏈中元素不重複；深度上限預設 16。

**產出**：7 個檔頭 docstring（清楚列介面與一行不變量）

---

### E. 實作一個 DSA（擇一：`cache_tbl` 或 `ttl_heap`）

* **`cache_tbl` 最小需求**

  * `get(k)`：回傳有效 RRSet；若過期或無則 None
  * `put(k, rrset, ttl)`：寫入並回拋到 `ttl_heap` 設定失效
  * `delete(k)`：刪除
  * 邊界：空鍵拒絕；覆寫時重置 TTL；容量（若有）與 LRU 勾連預留掛鉤
* **`ttl_heap` 最小需求**

  * `push(deadline, k)`：入堆
  * `pop_expired(now)`：批次彈出 `deadline <= now` 的鍵
  * `peek_deadline()`：觀測下一個到期時間
  * 邊界：`now` 單調不回繞；過期可能多筆；允許重複鍵（由上層去重）

**產出**：完成的模組程式碼 + 對應測試（見下一節）

---

### F. 測試（3 條：典型／邊界／負例）

```bash
pytest -q
```

* 典型：正常 `put/get` 或 `push/pop_expired` 行為
* 邊界：到期/重覆鍵/空鍵
* 負例：取不存在鍵、過期鍵
  **產出**：`tests_report.txt`（包含綠燈摘要）

---

### G. 設定占位

* 編輯 `config/settings.py`：

  ```python
  TIMEOUT_MS = 800
  RETRY_MAX = 2
  ```

**產出**：設定檔 diff

---

### H. 對外檔案與 Roadmap 勾點

* 新增 `LICENSE`（MIT）
* 在 README 的 Roadmap 勾選「v1」相關進度：

  * 「七 DSA 接口草案完成」
  * 「1 個 DSA 已實作 + 測試通過」
    **產出**：LICENSE 檔、README diff

---

### I.（選做）封包觀測

* 用 Wireshark 或 `tcpdump` 觀察 UDP:8053 一來一回
  **產出**：1 張截圖或 `pcapng` 檔

---

## 4) 今日交付清單（文件與證據）

* `shell.log`（環境與測試健康檢查）
* `dig_output.txt`（ANSWER SECTION）
* 7 個 DSA 檔頭 docstring（介面 + 不變量）
* 1 個 DSA 模組實作檔 + 對應測試檔（3 條）
* `tests_report.txt`
* `config/settings.py` diff
* `LICENSE`（MIT）
* README diff（資料路徑備忘 + Roadmap 勾點）
  -（選做）封包截圖或 `pcapng`

---

## 5) 驗收清單（勾了就過）

* [ ] `pytest -q` 可執行且綠燈（至少今日新增測試全過）
* [ ] `dig @127.0.0.1 -p 8053 example.lab A` 有 ANSWER
* [ ] README 已新增資料路徑備忘一行
* [ ] 七個 DSA 檔頭完成介面與不變量一句話
* [ ] 1 個 DSA 實作完成並通過 3 條測試
* [ ] `TIMEOUT_MS`、`RETRY_MAX` 已落在設定檔
* [ ] `LICENSE` 已加入；Roadmap 勾選今日完成項

---

## 6) Commit 規範（建議三筆）

1. `docs+env`: add daily task 2025-08-30, venv/pytest healthcheck, README path note, LICENSE
2. `ds-interfaces`: add minimal interfaces + invariants docstrings for 7 DS modules
3. `ds-impl+tests`: implement <chosen-DS> (+ tests), add settings defaults

---

## 7) TN（明日軸）

以今日基線為起點，拼起「快取三件套」：完成 `ttl_heap`/`lru_dlist` 與 `cache_tbl` 的勾連；新增 hit/miss/evict/expire 的可觀測指標。
